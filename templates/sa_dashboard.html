<!DOCTYPE html>
<html lang="en">
<head>
    <title>Super Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-5">

<a href="/sa/profile" class="btn btn-secondary mb-4 float-end">Settings</a>

<h2 class="mb-4">Super Admin Dashboard</h2>

<!-- ðŸ”” FLASH MESSAGES (ADMIN CREDENTIALS / ALERTS) -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show">
        {{ message|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- âž• CREATE BUSINESS (ADMIN AUTO-CREATED IN BACKEND) -->
<form method="post" action="/sa/create-business" class="mb-5">
    <div class="row g-3">
        <div class="col-md-3">
            <input class="form-control" name="name" placeholder="Business Name" required>
        </div>
        <div class="col-md-3">
            <input class="form-control" name="business_key" placeholder="Business Key (unique)" required>
        </div>
        <div class="col-md-4">
            <input class="form-control" name="webhook_url" placeholder="Webhook URL (optional)">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100">Create Business</button>
        </div>
    </div>
    <small class="text-muted">
        âœ” Admin account will be auto-created for this business
    </small>
</form>

<!-- ðŸ“‹ BUSINESS TABLE -->
<table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Key</th>
            <th>Active</th>
            <th>Created</th>
            <th>Sub Start</th>
            <th>Sub End</th>
            <th>Admins</th>
            <th>Webhook</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>

    {% for detail in businesses %}
    <tr {% if detail.is_expired %}class="table-danger"{% endif %}>
        <td>{{ detail.business.id }}</td>
        <td>{{ detail.business.name }}</td>
        <td><code>{{ detail.business.business_key }}</code></td>
        <td>
            {% if detail.business.is_active %}
                <span class="badge bg-success">Yes</span>
            {% else %}
                <span class="badge bg-secondary">No</span>
            {% endif %}
        </td>
        <td>{{ detail.business.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>{{ detail.business.subscription_start.strftime('%Y-%m-%d') if detail.business.subscription_start else 'N/A' }}</td>
        <td>{{ detail.business.subscription_end.strftime('%Y-%m-%d') if detail.business.subscription_end else 'N/A' }}</td>

        <!-- ðŸ‘¤ ADMINS (AUTO-CREATED) -->
        <td>
            {% if detail.admins %}
                <ul class="mb-0 ps-3">
                    {% for admin in detail.admins %}
                        <li>{{ admin }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <span class="text-danger">No Admin</span>
            {% endif %}
        </td>

        <td>{{ detail.business.webhook_url or 'â€”' }}</td>

        <!-- âš™ ACTIONS -->
        <td>
            <a href="/sa/edit-business/{{ detail.business.id }}" class="btn btn-sm btn-warning mb-1">Edit</a>

            <form method="post" action="/sa/renew-business/{{ detail.business.id }}" class="d-inline">
                <button class="btn btn-sm btn-success mb-1">Renew</button>
            </form>

            <form method="post" action="/sa/delete-business/{{ detail.business.id }}" class="d-inline"
                  onsubmit="return confirm('Delete this business?');">
                <button class="btn btn-sm btn-danger mb-1">Delete</button>
            </form>
        </td>
    </tr>

    <!-- ðŸ”Œ INTEGRATION CODE -->
    <tr>
        <td colspan="10">
            <button class="btn btn-sm btn-secondary" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#code{{ detail.business.id }}">
                Show Integration Code
            </button>

            <div class="collapse mt-2" id="code{{ detail.business.id }}">
<pre><code>&lt;script&gt;
(function () {
  window.ChatBoxID = "{{ detail.business.business_key }}";
  const script = document.createElement("script");
  script.src = "https://YOUR-RENDER-APP.onrender.com/static/widget_loader.js";
  document.body.appendChild(script);
})();
&lt;/script&gt;</code></pre>
            </div>
        </td>
    </tr>

    {% endfor %}
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>